{
    "contents" : "---\ntitle: \"Survival HW3 Yifu Liu\"\nauthor: \"YL\"\ndate: \"November 19, 2016\"\noutput: pdf_document\n---\n##=================================================================================================\n8.4. (a) \n```{r}\nlibrary(survival)\nlibrary(KMsurv)\ndata(bnct)\n#ratdata<-data.frame(c(bnct[bnct$trt==1,]$time),c(bnct[bnct$trt==2,]$time),c(bnct[bnct$trt==3,]$time))\nratcox<-coxph(Surv(time,death)~I(trt==2)+I(trt==3),bnct,method=\"breslow\")\nsummary(ratcox)\nround(c(ratcox$coef, se=sqrt(diag(ratcox$var))),4) \nround(exp(2*(ratcox$coef[1]+c(-1,1)*1.96*sqrt(ratcox$var[1,1]))),4)\n##Thus, the confidence interval is [0.0030, 0.2393].\n```\n##=================================================================================================\n8.4. (b) \n```{r}\n#Here we test if beta_1 = beta_2=0\nsummary(ratcox)\n```\nFrom the summary(ratcox), we see the p-value for likelihood ratio test is p=1.139e-06, p-value for Wald test is p=1.336e-05 and p-value for Score test is p=1.282e-07.\n##=================================================================================================\n8.4. (c)-(d) \n```{r}\nj<-c((ratcox$coef %*%c(-1,1) )/sqrt(c(-1,1) %*% ratcox$var %*% c(-1,1))) \nj\n#the P-value is highly significant\n2*(1- pnorm(-j)) \nc(EstRR = exp(ratcox$coef %*% c(-1,1)), \nCI=exp(2*(ratcox$coef %*%c(-1,1) + c(-1,1)*1.96*sqrt(c(-1,1) %*% ratcox$var %*% c(-1,1)))))\n```\n##=================================================================================================\n8.4. (e)-(f) \n```{r}\n#some of e and f) part:\nratcox1<-coxph(Surv(time,death)~ I(trt>1), bnct, method=\"breslow\")\nsummary(ratcox1)\nratcoxall <- coxph(Surv(time,death) ~ I(trt>1), bnct, robust=T,method=\"breslow\")\nsummary(ratcoxall)\nsqrt(c(Naive.var=ratcoxall$naive, Robust.var=ratcoxall$var))\n#e) part:\n#It test for beta_1 =0 or beta_2=0, we can do it with cox model with single covariate=Z1+Z2\nplot(survfit(ratcox))\nplot(survfit(ratcox1))\ncoxhazard <- basehaz(ratcox, FALSE)\ncoxhazard\n```\n\n##=================================================================================================\n8.8. (a)\n```{r}\ndata(bmt)\nbmt_dat = bmt[,c(1,3,6,19)]\nbmt_dat = bmt_dat[bmt_dat$group==1,]\nchisq_value = c()\nfor (i in seq(from=80,to=2600,by=2)) {\nss<-c(1:length(bmt_dat$z7))\nfor(j in 1:length(ss)){\nif(bmt_dat$z7[j]>i){\n  ss[j]<-1\n}else{\n  ss[j]<-0\n  }\n}\ncutoff = survdiff(Surv(t2, d3)~ss, data=bmt_dat)\nchisq_value = c(chisq_value,cutoff$chisq) }\ncutoff_time = 80+min(which(chisq_value==max(chisq_value)))*2\ncutoff_time\n```\nThe Waiting Time to Transplant In Days are 946. For the value of smaller than 946, it is classified as high risk group. If the value is greater than 946, it is classified as low risk group.\n##=================================================================================================\n8.8. (b)\n```{r}\nss<-c(1:length(bmt_dat$z7))\nfor(j in 1:length(ss)){\nif(bmt_dat$z7[j]>946){\n  ss[j]<-1\n}else{\n  ss[j]<-0\n  }\n}\nmodelb = coxph(Surv(t2, d3)~ss, data=bmt_dat)\nsummary(modelb)\n```\nThe parameter is -1.6422, the standard error is 1.0238. The relative risk of high risk group to low risk group is 5.167 for all group.\n\n##=================================================================================================\n8.8. (c)\n```{r}\nmodelc = coxph(Surv(t2, d3)~z7, data=bmt_dat)\nsummary(modelc)\n```\nThe parameter is 0.0002616, the standard error is 0.0003851. The relative risk of high risk group to low risk group is 1. The cutoff point works better than the continuous variable.\n\n##=================================================================================================\n8.10. (a)\n```{r}\ndata(bmt)\ncoxMTX <- coxph(Surv(ta,da)~factor(z10),data=bmt,method=\"breslow\")\nsummary(coxMTX)\nround(c(exp(coxMTX$coef), se=exp(sqrt(diag(coxMTX$var)))),4)\nround(exp(coxMTX$coef+c(-1,1)*1.96*sqrt(coxMTX$var)),4)\n#So the confidence interval is from 0.2978 to 1.8469\n```\n##=================================================================================================\n8.10. (b)\n```{r}\ncoxgroup<- coxph(Surv(ta,da)~factor(z10)+factor(group), data=bmt,method=\"breslow\")\nsummary(coxgroup)\n#As p value greater than 0.05, we conclude to reject the null hypothesis. \n#Thus, the alternative hypothesis that there is no effect of MTX \n#on development of AGVHD on adjusting for the three disease categories.\n```\n##=================================================================================================\n8.10. (c)\n```{r}\ncox_interaction <- coxph(Surv(ta,da)~factor(z10)*factor(group), data=bmt,method=\"breslow\")\nsummary(cox_interaction)\nanova(coxgroup,cox_interaction)\n#we conclude no interaction\n```\n##=================================================================================================\n8.10. (d)\n```{r}\ncox_final<- coxph(Surv(ta,da)~z1+factor(z3)+factor(z5)+z7+factor(z8)+factor(group)+factor(z10), data=bmt,method=\"breslow\")\n#model selection by AIC and BIC\nstep(cox_final,direction=\"both\")\nstep(cox_final,direction=\"both\",k=log(nrow(bmt)))\nmodel_AIC <- coxph(Surv(ta,da)~z1 + factor(group) + factor(z10),\n                   data=bmt,method=\"breslow\")\nmodel_BIC <- coxph(Surv(ta,da)~z1 + factor(z10), data=bmt, method=\"breslow\")\nanova(model_AIC, model_BIC)\n#we see BIC works better here.\nsummary(model_BIC)\n#From the summary of modelBIC, we see our final model\n```\n##=================================================================================================\n8.12. \n```{r}\nlibrary(usdm)\ndata(std)\n##delete unnecessary variable such as os30d, rs30d and so on.\nstd <- na.omit(std[,-c(1,9,11,20)])\n##detecting collinearity for continuous variables \n##and we find out no collinearity between continous variable\nvif(std[,c(3,4,6,12)])\n```\n\n```{r}\n#find unbalanced group and drop unbalanced variable\ntable(std$iinfct);table(std$os12m );table(std$rs12m);table(std$abdpain);table(std$discharge);table(std$dysuria);table(std$itch)\ntable(std$lesion);table(std$rash);table(std$lymph);table(std$dchexam);table(std$abnode);table(std$race);table(std$marital)\nstd_reduced <- std[,-c(2,14,15,16,17,18)] \n##See how the model works now.\ncox.reduced <- coxph(Surv(time,rinfct)~.,data=std_reduced,method=\"breslow\")\nsummary(cox.reduced)\n##see if proportional hazards assumption holds\ncox.zph(cox.reduced)\n```\n\nSince the assumption holds, we can use AIC to do model selection.\n```{r}\nstep(cox.reduced,direction=\"both\")\n#See the final model\nfinal_model <- coxph(Surv(time,rinfct)~ yschool + iinfct + npartner + os12m + abdpain + condom, data=std,method=\"breslow\")\nsummary(final_model)\n```\nWe see all variables are now significant by their p-values. Thus, the final model includes variables of years of schooling, initial infection, number of partners, presence of abdominal pain, condom use, oral sex within 12 months.\n",
    "created" : 1482090241689.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "898696974",
    "id" : "1C38CD99",
    "lastKnownWriteTime" : 1479603288,
    "path" : "~/Desktop/survival class/Survival HW3 Yifu Liu.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 9,
    "source_on_save" : false,
    "type" : "r_markdown"
}