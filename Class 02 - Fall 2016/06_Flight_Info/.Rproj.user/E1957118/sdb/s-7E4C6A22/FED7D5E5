{
    "contents" : "---\ntitle: \"Survival HW4 Yifu Liu\"\nauthor: \"YL\"\ndate: \"Dec 3, 2016\"\noutput: pdf_document\n---\n##=================================================================================================\n11.2: In section 1.14 a study of the times to weaning of breast-fed newborns was presented. This data is available on our web site. Categorical variables which could explain the difference in weaning times are the mother’s race (white, black, other), smoking status, and an indicator of whether the mother was in poverty. Continuous variables which could explain outcome are the mother’s age at the child’s birth, mother’s years of education, and the child’s year of birth. Using a Cox model with appropriate terms for the mother’s race, smoking status, and poverty indicator, determine if each of the three continuous covariates would enter the model as a linear function.\n```{r}\nlibrary(survival)\nlibrary(KMsurv)\ndata(bfeed)\nhead(bfeed)\n##We use martingale residual plot to check if a continuous variable is \n##appropriate to be added in Cox model as a linear term.\n##Step 1: add these continuous variable into the Cox model separately. \n##And we use \"breslow\" method as there are ties in the problem\nfit.age<-coxph(Surv(duration,delta)~factor(race)+factor(smoke)+factor(poverty)\n               +agemth,data=bfeed, method=\"breslow\")\nfit.birth<-coxph(Surv(duration,delta)~factor(race)+factor(smoke)+factor(poverty)\n                 +ybirth,data=bfeed, method=\"breslow\")\nfit.edu<-coxph(Surv(duration,delta)~factor(race)+factor(smoke)+factor(poverty)\n               +yschool,data=bfeed, method=\"breslow\")\n##Step 2: check these continuous variable with martingale residual plot\n#Age of mother at birth of child\nplot(bfeed$agemth, resid(fit.age),col=1,xlab=\"Age of mother at birth of child\",\n     ylab=\"Martingale Residuals\", main=\"Martingale Residuals Plot\"); \nlines(lowess(bfeed$agemth, resid(fit.age)),col=4)\n\n#Year of birth\nplot(bfeed$ybirth, resid(fit.birth),col=2,xlab=\"Year of birth\",\n     ylab=\"Martingale Residuals\",main=\"Martingale Residuals Plot\"); \nlines(lowess(bfeed$ybirth, resid(fit.birth)),col=4)\n\n#Education level of mother\nplot(bfeed$yschool, resid(fit.edu),col=3,xlab=\"Education level of mother\",\n     ylab=\"Martingale Residuals\",main=\"Martingale Residuals Plot\"); \nlines(lowess(bfeed$yschool, resid(fit.edu)),col=4)\n```\nWe can see these three martingale residual plots, the lowess line is approximately straight and it is across 0 which indicates no transformation is needed. We can conclude these continuous covariates can enter the model as a linear function.\n\n##=================================================================================================\n11.4: (a) Check the proportional hazards assumption for this data by plotting the logarithms of the cumulative baseline hazard rates for each ploidy group.\n```{r}\nlibrary(survival)\nlibrary(KMsurv)\ndata(tongue)\n#again, with ties, we use \"breslow\" method\nfit3=survfit(coxph(Surv(time,delta)~strata(factor(type)),data=tongue,method='breslow'),type='aalen')\nplot(fit3,fun=\"cloglog\", col=c(\"blue\",\"red\"),\n\txlab=\"Time on Study\",ylab=\"Log Cumulative Hazard Rate\",\n\tmain=\"Log Cumulative Hazard Rate\")\nlegend(\"bottomright\", legend = c(\"Aneuploid group\",\"Diploid group\"),\n       col = c(\"Blue\", \"red\"), lty = c(1, 1),bty =\"n\")\n\n```\n\nFrom the graph, we see the proportional hazards assumption does not hold since the blue and red lines cross. They can not be parallel apparently.\n\n##=================================================================================================\n11.4: (a)(another medthod) Check the proportional hazards assumption for this data by plotting the logarithms of the cumulative baseline hazard rates for each ploidy group.\n```{r}\ndata(tongue)\nAneuploid_data<-tongue[tongue$type==1,]\nDiploid_data<-tongue[tongue$type==2,]\nmy.surv <- Surv(Aneuploid_data$time, Aneuploid_data$delta)\nmy.fit <- summary(survfit(my.surv ~ 1))\n#Nelson-Aalen estimator\nh.sort.of <- my.fit$n.event / my.fit$n.risk\nH.tilde <- cumsum(h.sort.of)\nH.tilde <- c(H.tilde, tail(H.tilde, 1))\n#log(H.tilde) is log cumsum for Aneuploid\nplot(c(my.fit$time, 400), log(H.tilde), xlab=\"time\", ylab=\"Log cumulative hazard rate\",\n      main=\"Log cumulative hazards rate\", type=\"s\",col=\"red\")\n\n\nmy.surv1 <- Surv(Diploid_data$time, Diploid_data$delta)\nmy.fit1 <- summary(survfit(my.surv1 ~ 1))\n#Nelson-Aalen estimator\nh.sort.of1 <- my.fit1$n.event / my.fit1$n.risk\nH.tilde1 <- cumsum(h.sort.of1)\nH.tilde1 <- c(H.tilde1, tail(H.tilde1, 1))\n#log(H.tilde1) is log cumsum for Diploid\nlines(c(my.fit1$time, 231), log(H.tilde1), type='s',col=\"blue\")\nlegend(\"bottomright\", c(\"Diploid\",\"Aneuploid\"), col=c(\"blue\",\"red\"),lty=c(1,1))\n#From the graph, we see the proportional hazards assumption does not hold since the blue and red lines cross. They can not be parallel apparently.\n```\n\nFrom the graph, we see the proportional hazards assumption does not hold since the blue and red lines cross. They can not be parallel apparently.\n\n##=================================================================================================\n11.4: (b) Check for proportional hazards by plotting the difference in the log cumulative hazard rates for the two groups.\n```{r}\ntemp_data<-matrix(nrow=231, ncol=3)\ntemp_data[, 1]<-1:231\nfor(i in 1:231){\n  temp_data[i, 2]<-max(H.tilde1[c(my.fit1$time, 231)<=i]) #Diploid data\n}\nfor(i in 1:231){\n  temp_data[i, 3]<-max(H.tilde[c(my.fit$time, 400)<=i]) #Aneuploid data\n}\ntemp_data<-data.frame(temp_data)\ncolnames(temp_data)<-c(\"time\",\"dataDiploid\",\"dataAneuploid\")\nplot(temp_data$time, log(temp_data$dataDiploid/temp_data$dataAneuploid), type='s', \n     main=\"Difference in Log Cumulative Hazard Rates\",xlab=\"Time\",\n     ylab=\"Difference in Log Cumulative Hazard Rates\")\n\n```\n\nAgain, the proportional hazards assumption is rejected because the plotted curve is not roughly constant over time. \n\n##=================================================================================================\n11.4: (c) Check for proportional hazards by using an Andersen plot.\n```{r}\nplot(temp_data$dataDiploid, temp_data$dataAneuploid, type='s',\n     main=\"Anderson Plot\", xlab=\"Cumulative Hazard for Diploid Tumor\", \n     ylab=\"Cumulative Hazard for Aneuploid Tumor\")\nlegend(\"bottomright\", \"Slope= 0.65\", col=\"red\", lty=1)\nabline(0, lm(temp_data$dataAneuploid~0+temp_data$dataDiploid)$coefficient, col=\"red\")\nlm(temp_data$dataAneuploid~0+temp_data$dataDiploid)$coefficient\n```\nWe see that proportional hazards assumption holds since the line is approximately straight.\n\n##=================================================================================================\n11.4: (d) Check for proportional hazards by using a score residual plot.\n```{r}\ndata(tongue)\n##sorting the time as increasing\norder <- order(tongue$time)\ntime <- tongue$time[order]\n\n##Score residual plot\nmy.fit <- coxph(Surv(time,delta)~factor(type), data=tongue[order,], method=\"breslow\")\nplot(time, resid(my.fit,type=\"score\"),type=\"o\",col=\"blue\",xlab=\"Time on Study\",\nylab=\"Score Residuals\",main=\"Score Residuals Plot\",ylim=c(-2,2))\nabline(h=c(1.3581,-1.3581))\n\n```\n\nThe dotted lines at 1.3581 are chosen so that the probability that the supremum is beyond these values is 0.05 at most. Should the plot exceed these boundaries at any point, the assumption of proportional hazards can be rejected at a 5% level of significance. Here again, we find evidence of nonproportionality of the hazards for patients given\ndifferent types of DNA profile.\n\n##=================================================================================================\n11.6: (a) For the data on survival times of patients with an aneuploid or diploid DNA tumor profile in Exercise 4 determine which, if any, observations are outliers by making an appropriate deviance residual plot.\n```{r}\ndata(tongue)\nmy.fit <- coxph(Surv(time,delta)~factor(type), data=tongue, method=\"breslow\")\n#Deviance Residuals\nplot(tongue$type, resid(my.fit, type=\"deviance\"),col=\"green\",xlab=\"Type\",\nylab=\"Deviance Residuals\",main=\"Deviance Residuals Plot\")\ndeviance.res <- resid(my.fit,type=\"deviance\")\ndeviance.res[which(abs(deviance.res)>=1.96)]\ntongue[79:80,]\n```\nWe see observations with time = 176 and 231 in type 2 group are outliers. The deviance residual plot shows moderate normality. It looks really different from book example since there is only one covariate which is dummy variable.\n\n##=================================================================================================\n11.6: (b) Find the three points that have the greatest influence on the estimate of the regression effect by constructing a plot of the adjusted score residuals. Explain why these three points are so influential in light\nof your fitted regression model.\n```{r}\ndata(tongue)\nmy.fit <- coxph(Surv(time,delta)~factor(type), data=tongue, method=\"breslow\")\n## influence\nplot(resid(my.fit, type=\"dfbetas\"),col=\"orange\",xlab=\"Observation number\",\nylab=\"Influence\",main=\"Influence Plot\")        #dfbeta is unscaled by SE of beta\nres.df <- abs(resid(my.fit, type=\"dfbetas\"))\n#fined three points that have the greatest influence\nwhich.max(res.df)\nwhich.max(res.df[-80])\nwhich.max(res.df[-c(79,80)])\ntongue[78:80,]\nsummary(my.fit)\nmy.fit.new <- coxph(Surv(time,delta)~factor(type), data=tongue[-c(78:80),], method=\"breslow\")\nsummary(my.fit.new)\n```\nWe see observations with in type 2 with time = 104, 176 and 231 are potential outliers which make the greatest incluence. From the summary(my.fit), exp(beta) is 1.586 for the variable \"type\" which means that patients who has diploid tumor(type=2) tend to have bigger hazard rate compared to patients with aneuploid tumor(type=1). Thus, the first 3 largest survival time in type 2 group will be considered as outlier. We can see these three patients with delta =0 which means they are still alive which is highly unlikely. By removing the three points, we see big relative difference of exp(beta) in my.fit.new compare to my.fit\n",
    "created" : 1482090380287.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "3291534263",
    "id" : "FED7D5E5",
    "lastKnownWriteTime" : 1480821943,
    "path" : "~/Desktop/survival class/Survival HW4 Yifu Liu.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 10,
    "source_on_save" : false,
    "type" : "r_markdown"
}