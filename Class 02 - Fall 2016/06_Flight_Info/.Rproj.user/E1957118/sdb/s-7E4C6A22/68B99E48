{
    "contents" : "---\ntitle: \"Survival HW2 Yifu Liu\"\nauthor: \"YL\"\ndate: \"October 29, 2016\"\noutput: pdf_document\n---\n##=================================================================================================\n(a) Estimate the survival (infection-free) functions and their standard errors for the chlorhexidine and povidone-iodine groups.\n```{r}\nlibrary(KMsurv)\nlibrary(survival)\ndata(burn)\nroutine_bathing = burn[burn$Z1==0,]\nbody_cleansing = burn[burn$Z1==1,]\n\nmodel_bath = survfit(formula=Surv(routine_bathing$T3,routine_bathing$D3)~1)\nsummary(model_bath)\n\nmodel_cleansing = survfit(formula=Surv(body_cleansing$T3,body_cleansing$D3)~1)\nsummary(model_cleansing)\n\nplot(survfit(formula=Surv(burn$T3,burn$D3)~burn$Z1),col=c(\"orange\",\"purple\"), lty=c(1:2), lwd=3)\nlegend(\"bottomleft\",c(\"providone-iodine group\", \"Chlorhexidine group\"), lty = c(1:2), col=c(\"orange\",\"purple\"),cex=0.5)\n##=================================================================================================\n```\n\n(b) Estimate the cumulative hazard rates and their standard errors for the chlorhexidine and povidone-iodine groups. Plot these estimates. Does it appear that the two cumulative hazard rates are proportional to each other?\n```{r}\n## For the chlorhexidine group\nCHR_cleansing = with(summary(model_cleansing), data.frame(time, n.risk, n.event,surv,std.err))\nCHR_cleansing$H = cumsum(CHR_cleansing$n.event/CHR_cleansing$n.risk)\nCHR_cleansing$se_H = sqrt(cumsum(CHR_cleansing$n.event/(CHR_cleansing$n.risk^2)))\nCHR_cleansing\n\n## For the povidone-iodine group\nCHR_bath = with(summary(model_bath), data.frame(time, n.risk, n.event,surv,std.err))\nCHR_bath$H = cumsum(CHR_bath$n.event/CHR_bath$n.risk)\nCHR_bath$se_H = sqrt(cumsum(CHR_bath$n.event/(CHR_bath$n.risk^2)))\nCHR_bath\n\n## plot the estimates of H(x)\nfit_compare <- survfit(Surv(T3,D3)~Z1,data=burn,conf.type=\"none\")\nplot(fit_compare, fun=\"cumhaz\",conf.int=FALSE, col=c(\"orange\",\"red\"), xlab=\"Time\", ylab =\"Cumulative Hazard Rates\",main = \"Cumulative Hazard Function\")\nlegend(\"bottomright\", legend = c(\"chlorhexidine group\",\"povidone-iodine group\"), col = c(\"red\", \"blue\"), lty = c(1, 1),bty =\"n\")\n\n```\n* From the above plot we can see that the two cumulative hazard rates are not proportional to each other.\n##=================================================================================================\n(c) Provide estimates of the median time to infection and find 95% confidence intervals for the median time to infection for both the chlorhexidine and povidone-iodine groups using the linear, log-transformed, and arcsine formulas.\n##### For povidone-iodine group\n```{r}\n## linear \nlinear = (CHR_bath$surv-0.5)/CHR_bath$std.err\n## log transformation\nlog = ((log(-log(CHR_bath$surv))-log(-log(0.5)))*(CHR_bath$surv*log(CHR_bath$surv)))/CHR_bath$std.err\n## arcsine-square root transformation\narcsine = 2*(asin(sqrt(CHR_bath$surv))-asin(sqrt(0.5)))*sqrt(CHR_bath$surv*(1-CHR_bath$surv))/CHR_bath$std.err\ncbind(CHR_bath,linear,log,arcsine)\n```\n\nWe can find the 95% confidence interval for the median by selecting value between [-1.96, 1.96] from above frame, so the CI for both three methods are x >23. The estimated median is x = 47, because surv(x=47)=0.426<0.5.\n\n##### For chlorhexidine group \n```{r}\n## linear \nlinear = (CHR_cleansing$surv-0.5)/CHR_cleansing$std.err\n## log transformation\nlog = ((log(-log(CHR_cleansing$surv))-log(-log(0.5)))*(CHR_cleansing$surv*log(CHR_cleansing$surv)))/CHR_cleansing$std.err\n## arcsine-square root transformation\narcsine = 2*(asin(sqrt(CHR_cleansing$surv))-asin(sqrt(0.5)))*sqrt(CHR_cleansing$surv*(1-CHR_cleansing$surv))/CHR_cleansing$std.err\ncbind(CHR_cleansing,linear,log,arcsine)\n```\n\nWe can find the 95% confidence interval for the median by selecting value between [-1.96, 1.96] from above frame, so the CI for both three methods are x > 42. The estimated median is larger than 47, we cannot find the exact value.\n##=================================================================================================\n(d) Find 95% confidence intervals for the survival (infection-free) functions at 10 days postadmission for both the chlorhexidine and povidone-iodine groups using the log transformed and arcsine transformed formulas.\n##### For povidone-iodine group\nAt 10 days postadmission, the estimated survival function S(10) is 0.736 with an estimated standard error of 0.0535.\n```{r}\n## log transformation\nS10 = 0.736\nse_S10 = 0.0535\nsigma = se_S10/S10\ntheta = exp((1.96*sigma)/log(S10))\nc(S10^(1/theta), S10^theta)\n\n#### method 2\nfit = survfit(Surv(T3,D3)~1, data=burn[burn$Z1==0,], conf.type=\"log-log\")\nsummary(fit, times=c(10))\n\n## arcsine-square root transformation\nlower = (sin(max(0,asin(sqrt(S10))-0.5*1.96*sigma*sqrt(S10/(1-S10)))))^2\nupper = (sin(min(CHR_bath/2,asin(sqrt(S10))+0.5*1.96*sigma*sqrt(S10/(1-S10)))))^2\nc(lower, upper)\n```\n\nThe 95% confidence interval for $\\hat{S}(10)$ for the povidone-iodine group using the log transformed is (0.614, 0.825).\nThe 95% confidence interval for $\\hat{S}(10)$ for the povidone-iodine group using the arcsine transformed formulas is (0.625, 0.833).\n\n##### For chlorhexidine group \nAt 10 days postadmission, the estimated survival function S(10) is 0.856 with an estimated standard error of 0.0384.\n```{r}\n## log transformation\nS10 = 0.856\nse_S10 = 0.0384\nsigma = se_S10/S10\ntheta = exp((1.96*sigma)/log(S10))\nc(S10^(1/theta), S10^theta)\n\n## arcsine-square root transformation\nlower = (sin(max(0,asin(sqrt(S10))-0.5*1.96*sigma*sqrt(S10/(1-S10)))))^2\nupper = (sin(min(3.1415/2,asin(sqrt(S10))+0.5*1.96*sigma*sqrt(S10/(1-S10)))))^2\nc(lower, upper)\n```\n\nThe 95% confidence interval for $\\hat{S}(10)$ for the chlorhexidine group using the log transformed is (0.761, 0.915).\nThe 95% confidence interval for $\\hat{S}(10)$ for the chlorhexidine group using the arcsine transformed formulas is (0.773, 0.923).\n\n##=================================================================================================\nKM7.2\n```{r}\nlibrary(Icens)\nlibrary(FHtest)\nlibrary(survMisc)\n\ndata(alloauto)\n#This data frame contains the following columns:\n#time Time to death or relapse, months\n#type Type of transplant (1=allogeneic, 2=autologous)\n#delta Leukemia-free survival indicator (0=alive without relapse, 1=dead or relapse)\n#Test the folowing:\n#H_0 = 0.045\n#H_a > 0.045\n#The exponential survival rate is S(x) = exp(-0.045*x)\n#Then, we use one-sample log-rank test\nauto = alloauto[alloauto$type==2,]\ns= exp(-0.045*auto$time)\nsurvdiff(Surv(auto$time, auto$delta)~offset(s))\n#since we get the p-value of the test is 0.0933>0.05 which we fail to reject the null of H_0=0.045\n```\n```{r, message=FALSE}\n#Repeat this function using a weight function:\n#In fleming-harrington test, the weight is W(t)=Y(t)S^p_0(t)[1-S_0(t)]^q\n#The test is used to test early difference in h(t) when set p=1=rho, q=0\nsurvdiff(Surv(auto$time, auto$delta)~offset(s), rho=1)\n```\nwe conclude that the p-value is smaller than 0.277 which we do not reject the null hypothesis. Thus, the null hypothesis is true.\n\n##=================================================================================================\nKM7.10\n```{r}\nz <- c(-7.5660, -3.0117, 2.9155, 7.6623)\nsigma <- cbind(c(12.0740,-4.4516,-6.2465,-1.3759),c(-4.4516,7.8730,-2.7599,-0.6614),c(-6.2465,-2.7599,9.9302,-0.9238),c(-1.3759,-0.6614,-0.9238,2.9612))\n\npvalue<-c(0,0,0)\nfor (i in 1:3){\n  pvalue[i] <- pnorm((z[i]-z[i+1])/sqrt(sigma[i,i]+sigma[i+1,i+1]-2*sigma[i,i+1]), mean=0, sd=1)\n}\n\n#bonferroni correction\np.adjust(pvalue, method = \"bonferroni\", n = length(pvalue))\n\n#We conlcude all the p-values are statistically insignificant.\n```\n\n##=================================================================================================\n2(a)\n```{r}\nlibrary(OIsurv)\n#group Disease Group 1-ALL, 2-AML Low Risk, 3-AML High Risk\n#t1 Time To Death Or On Study Time\n#t2 Disease Free Survival Time (Time To Relapse, Death Or End Of Study)\n#d1 Death Indicator 1-Dead 0-Alive\n#d2 Relapse Indicator 1-Relapsed, 0-Disease Free\n#d3 Disease Free Survival Indicator 1-Dead Or Relapsed, 0-Alive Disease Free)\n#ta Time To Acute Graft-Versus-Host Disease\n#da Acute GVHD Indicator 1-Developed Acute GVHD 0-Never Developed Acute GVHD)\n#tc Time To Chronic Graft-Versus-Host Disease\n#dc Chronic GVHD Indicator 1-Developed Chronic GVHD 0-Never Developed Chronic GVHD\n#tp Time To Chronic Graft-Versus-Host Disease\n#dp Platelet Recovery Indicator 1-Platelets Returned To Normal, 0-Platelets Never Returned to Normal\n#z1 Patient Age In Years\n#z2 Donor Age In Years\n#z3 Patient Sex: 1-Male, 0-Female\n#z4 Donor Sex: 1-Male, 0-Female\n#z5 Patient CMV Status: 1-CMV Positive, 0-CMV Negative\n#z6 Donor CMV Status: 1-CMV Positive, 0-CMV Negative\n#z7 Waiting Time to Transplant In Days\n#z8 FAB: 1-FAB Grade 4 Or 5 and AML, 0-Otherwise\n#z9 Hospital: 1-The Ohio State University, 2-Alferd , 3-St. Vincent, 4-Hahnemann\n#z10 MTX Used as a Graft-Versus-Host- Prophylactic: 1-Yes 0-No\ndata(bmt)\ndata_bmt<-bmt[bmt$group==1,]\ntemp_out = survfit(formula=Surv(data_bmt$t2,data_bmt$d3)~1, conf.int = 0.90, conf.type = c(\"log\"))\nsummary(temp_out)\n```\n##=================================================================================================\n2(b)\n```{r}\nset.seed(100)\nboot_t = 1000\nsur_matrix = matrix(0,boot_t,1)\nfor (i in 1:1000){\nk = sample(length(data_bmt$group), replace=T)\ndata_t = data_bmt[k,]\ntemp_out = survfit(formula=Surv(data_t$t2,data_t$d3)~1)\nsur_matrix[i,1] = temp_out$surv[length(which(temp_out$time<150))]\n}\n\nquantile(sur_matrix[,1], c(0.05, 0.95))\n#The bootstrap 90% confidence interval is (0.6052632, 0.8421053).The wides of the confidence intervals in (a) and (b) are similar.\n#Both the lower and uppper bounds of bootstrap interval is smaller than the correspond interval in (a)\n```\n##=================================================================================================\n2(c)\n```{r}\nset.seed(100)\nu_limit = matrix(0,51,1000)\nl_limit = matrix(0,51,1000)\nfor (i in 1:1000){\np = sample(length(data_bmt$group), replace=T)\ndata_t = data_bmt[p,]\nc_band =  confBands(Surv(data_t$t2,data_t$d3), confLevel=0.90, type=\"hall\")\nind = max(which(c_band$time<=150))\n\nfor (j in 150:200){\n  if (j<c_band$time[ind]){\n      u_limit[j-149,i] = c_band$upper[ind-1]\n      l_limit[j-149,i] = c_band$lower[ind-1]}\n  else {\n    ind=ind+1}\n}\n}\nconfidence_band = matrix(0,51,2)\nconfidence_band[,1] = rowMeans(l_limit)\nconfidence_band[,2] = rowMeans(u_limit)\nconfidence_band[51,]\n```\n2(d)\n```{r}\nset.seed(100)\n\nsur_matrix = matrix(0,1000,1)\ndata_bmt = bmt[bmt$group==1,]\nfor (p in 1:1000){\nk = sample(length(data_bmt$group), replace=T)\ndata_t = data_bmt[k,]\ntemp_out = survfit(formula=Surv(data_t$t2,data_t$d3)~1)\nsur_matrix[p,1] = temp_out$surv[length(which(temp_out$time<150))]\n}\n\nset.seed(100)\ndata_bmt2 = bmt[bmt$group==2,]\nsur_matrix2 = matrix(0,1000,1)\nfor (q in 1:1000){\nk = sample(length(data_bmt2$group), replace=T)\ndata_t = data_bmt2[k,]\ntemp_out = survfit(formula=Surv(data_t$t2,data_t$d3)~1)\nsur_matrix2[q,1] = temp_out$surv[length(which(temp_out$time<150))]\n}\n\nsur_diff = sur_matrix-sur_matrix2\nquantile(sur_diff[,1], c(0.05, 0.95))\n```\n##=================================================================================================\n3(a)\nThe dying probility of month (0,3] is 54/292=0.185, the survival probility is 1-0.185= 0.815, the cumulative survival probility is 0.815.\nThe dying probility of month (3,6] is 36/232=0.155, the survival probility is 1-0.155= 0.845, the cumulative survival probility is $0.815*0.845=0.689$.\nThe dying probility of month (6,12] is 42/176=0.239, the survival probility is 1-0.239= 0.761, the cumulative survival probility is $0.689*0.761=0.524$.\nS(9) = (0.689+0.524)/2=0.607 since it is a straight line.\n```{r}\n##=================================================================================================\n```\n3(b)\n$$S(9) = 0.5*(S(6) + S(12))$$\n$$S(9) = 0.5*(p_1 p_2 + p_1 p_2 p_3) = 0.5* p_1 p_2 (1+p_3)$$\n$$log(S(9)) = log(0.5) + log(p_1) + log(p_2) + log(1+p_3)$$\n$$var(log(S(9))) = var(log(p_1)) + var(log(p_2)) + var(log(1+p_3))$$\n$$var(log(S(9))) = (1/p_1)^2 var(p_1) + (1/p_2)^2 var(p_2) + (1/(1+p_3))^2 var(p_3)$$\nvar(S(9)) = 0.607^2*((1/0.815)*(1/0.815)*(0.185*0.815)/292\n+(1/0.845)*(1/0.845)*(0.155*0.845)/232\n+(1/(1+0.761))*(1/(1+0.761))*(0.239*0.761)/176)= 0.0007\n\nThe confidence interval for S(9) is [S(9)-1.96*sqrt(var(S(9))), S(9)+1.96*sqrt(var(S(9)))] = [0.607-1.96*sqrt(0.0007),0.607+1.96*sqrt(0.0007)] = [0.555,0.659]\n```{r}\n##=================================================================================================\n```\n3(c)\nIf the HIV case occuring at the end of the end of the interval, the estimate of S(9) is 0.659. If the HIV case occuring at the beginning of the interval, the estimate of S(9) is 0.555.\n",
    "created" : 1482010127926.000,
    "dirty" : false,
    "encoding" : "UTF-8",
    "folds" : "",
    "hash" : "1171606806",
    "id" : "68B99E48",
    "lastKnownWriteTime" : 1480294170,
    "path" : "~/Desktop/survival class/Survival HW2 Yifu Liu.Rmd",
    "project_path" : null,
    "properties" : {
    },
    "relative_order" : 8,
    "source_on_save" : false,
    "type" : "r_markdown"
}